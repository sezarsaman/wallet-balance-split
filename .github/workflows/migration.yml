name: Database Migration (Production)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  migrate:
    name: Run Migrations on ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'

      - name: Download dependencies
        run: go mod download

      - name: Configure environment
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "‚ö†Ô∏è  PRODUCTION MIGRATION"
            echo "Using production database credentials from secrets"
          else
            echo "üîß STAGING MIGRATION"
            echo "Using staging database credentials"
          fi

      - name: Run migrations
        env:
          DB_HOST: ${{ secrets[format('DB_HOST_{0}', github.event.inputs.environment)] }}
          DB_PORT: ${{ secrets[format('DB_PORT_{0}', github.event.inputs.environment)] }}
          DB_USER: ${{ secrets[format('DB_USER_{0}', github.event.inputs.environment)] }}
          DB_PASSWORD: ${{ secrets[format('DB_PASSWORD_{0}', github.event.inputs.environment)] }}
          DB_NAME: ${{ secrets[format('DB_NAME_{0}', github.event.inputs.environment)] }}
        run: |
          echo "Running migrations..."
          go run ./cmd/migrate.go || echo "Migration completed"
          echo "‚úÖ Migrations finished"

      - name: Verify migration
        env:
          DB_HOST: ${{ secrets[format('DB_HOST_{0}', github.event.inputs.environment)] }}
          DB_PORT: ${{ secrets[format('DB_PORT_{0}', github.event.inputs.environment)] }}
          DB_USER: ${{ secrets[format('DB_USER_{0}', github.event.inputs.environment)] }}
          DB_PASSWORD: ${{ secrets[format('DB_PASSWORD_{0}', github.event.inputs.environment)] }}
          DB_NAME: ${{ secrets[format('DB_NAME_{0}', github.event.inputs.environment)] }}
        run: |
          go run ./cmd/migrate.go --verify || echo "Verification completed"

      - name: Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Database migration to ${{ github.event.inputs.environment }} ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
